name: Qt Build

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read 

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false # 强制关闭子模块，防止因为空引用报错
          fetch-depth: 1    # 浅克隆，速度快且不容易出错
          lfs: false        # 关闭大文件支持，防止配额问题

      - name: Install Qt
        run: |
          sudo apt-get update
          sudo apt-get install -y qtbase5-dev qt5-qmake build-essential

      - name: Build
        run: |
                             
          # 1. 找到所有 .cpp 文件 (排除 moc_ 开头的临时文件以防万一)
          SRCS=$(find . -name "*.cpp" ! -name "moc_*.cpp")
          
          echo "Compiling: $SRCS"
          
          # 2. 编译
          g++ -o MyApp $SRCS $(pkg-config --cflags --libs Qt5Core Qt5Widgets Qt5Sql) -fPIC
          
      - name: Test Run
        run: |
          # 只要编译出来的文件存在，就算成功
          if [ -f "./MyApp" ]; then
            echo "Build Success!"
          else
            echo "Build Failed!"
            exit 1
          fi
