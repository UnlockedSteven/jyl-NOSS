name: Qt Project CI

# 触发机制：推送到 main 分支或提交 PR 时触发
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 安装 Qt5 编译环境和 headless 运行环境 (xvfb)
    - name: Install Qt Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y qtbase5-dev qt5-qmake qtbase5-dev-tools \
                                libqt5sql5-sqlite build-essential \
                                xvfb pkg-config

    # 3. 编译项目
    - name: Compile Project
      run: |
        echo "正在编译项目..."
        
        # 假设你的项目包含以下文件，请根据实际情况调整文件名
        # -o RunGoods 指定输出文件名为 RunGoods
        g++ -o RunGoods \
            buygoodsdialog.cpp main.cpp \
            $(pkg-config --cflags --libs Qt5Core Qt5Gui Qt5Widgets Qt5Sql) \
            -fPIC -O2
            
        # 检查是否生成了可执行文件
        ls -l RunGoods

    # 4. 运行测试 (关键步骤)
    - name: Run Tests
      run: |
        # 使用 xvfb-run 在无显示器的服务器上模拟图形界面
        # 如果你有专门的单元测试文件，请替换 ./smoke_test.sh 为你的测试命令
        
        # 确保脚本有权限
        chmod +x smoke_test.sh
        
        # 在虚拟屏幕中运行测试脚本
        xvfb-run --auto-servernum ./smoke_test.sh
